<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Incident Command Center</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
    margin:0;
    font-family:Segoe UI;
    background:#0b1e35;
    color:white;
}
header{
    background:#132c4d;
    padding:15px;
    font-size:20px;
    text-align:center;
}
.container{
    display:flex;
    height:100vh;
}
.sidebar{
    width:220px;
    background:#132c4d;
    padding:10px;
    display:flex;
    flex-direction:column;
}
.sidebar button{
    width:100%;
    margin:6px 0;
    padding:12px;
    background:#1f3f66;
    border:none;
    color:white;
    cursor:pointer;
    font-size:15px;
    border-radius:6px;
}
.sidebar button:hover{
    background:#29598f;
}
.main{
    flex:1;
    padding:20px;
    overflow:auto;
}
.card{
    background:#1f3f66;
    padding:15px;
    margin:12px 0;
    border-radius:8px;
    line-height:1.5;
}
input,select{
    width:100%;
    padding:12px;
    margin:8px 0;
    font-size:16px;
    border-radius:6px;
    border:none;
}
button.action{
    padding:10px 14px;
    margin:6px 6px 6px 0;
    border:none;
    cursor:pointer;
    border-radius:6px;
    font-size:14px;
}
.orange{background:orange;color:white;}
.blue{background:#0099ff;color:white;}
.red{background:red;color:white;}
.green{background:green;color:white;}
.closeBtn{background:#444;color:white;}
.incDesc{
    color:#ff4444;
    font-weight:bold;
    font-size:16px;
}
.sectionTitle{
    margin-top:25px;
    border-bottom:1px solid #29598f;
    padding-bottom:6px;
}
a.mapLink{
    color:#00e5ff;
    font-weight:bold;
    text-decoration:none;
}
.timer{
    color:#00e5ff;
    font-weight:bold;
    margin-top:5px;
}
section{display:none;}
.statBox{
    background:#1f3f66;
    padding:20px;
    margin:15px 0;
    border-radius:8px;
    font-size:18px;
}

/* MOBILE */
@media (max-width:768px){
    .container{flex-direction:column;height:auto;}
    .sidebar{width:100%;flex-direction:row;}
    .sidebar button{flex:1;margin:4px;font-size:13px;padding:10px;}
}
</style>
</head>

<body>

<header> Dispatch Command Center OESF</header>

<div class="container">

<div class="sidebar">
<button onclick="show('dashboard')">Dashboard</button>
<button onclick="show('createIncident')">Create Incident</button>
<button onclick="show('onDutyRoster')">OnDuty Roster</button>
<button onclick="show('statistics')">Statistics</button>
<button onclick="signOut()">Sign Out</button>
</div>

<div class="main">

<section id="signIn">
<h2>Sign In / Sign Up</h2>
<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<input id="responderName" placeholder="Name">
<input id="vehicle" placeholder="Vehicle (Color / Reg)">
<button onclick="signUp()">Sign Up</button>
<button onclick="signInUser()">Sign In</button>
</section>

<section id="dashboard">
<h2 class="sectionTitle">Active Incidents</h2>
<div id="activeIncidents"></div>

<h2 class="sectionTitle">Completed Incidents</h2>
<div id="completedIncidents"></div>
</section>

<section id="createIncident">
<h2>Create Incident</h2>
<input id="address" placeholder="Address">
<input id="description" placeholder="Description">
<input id="contact" placeholder="Contact On Scene">
<select id="priority">
<option>Low</option>
<option>Medium</option>
<option>High</option>
<option>Critical</option>
</select>
<button onclick="createIncident()">Create Incident</button>
</section>

<section id="onDutyRoster">
<h2>OnDuty Roster</h2>
<div id="rosterList"></div>
</section>

<section id="statistics">
<h2>Incident Statistics</h2>
<div id="statsContent"></div>
</section>

</div>
</div>

<!-- AUDIO ALERTS -->
<audio id="respondingSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>
<audio id="standingOffSound" src="https://www.soundjay.com/button/beep-09.wav"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  updateDoc,
  deleteDoc,
  doc,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut as fbSignOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "PASTE_HERE",
  authDomain: "PASTE_HERE",
  projectId: "PASTE_HERE",
  storageBucket: "PASTE_HERE",
  messagingSenderId: "PASTE_HERE",
  appId: "PASTE_HERE"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let incidents = [];
let responders = [];
let currentUser = null;

/* AUTH */
window.signUp = async () => {
    if(!email.value || !password.value || !responderName.value || !vehicle.value){
        alert("All fields required");
        return;
    }
    const cred = await createUserWithEmailAndPassword(auth, email.value, password.value);
    await addDoc(collection(db,"responders"),{
        uid:cred.user.uid,
        name:responderName.value,
        vehicle:vehicle.value,
        status:"Available"
    });
    email.value=""; password.value=""; responderName.value=""; vehicle.value="";
};

window.signInUser = async () => {
    const cred = await signInWithEmailAndPassword(auth,email.value,password.value);
    currentUser = cred.user;
    show('dashboard');
    email.value=""; password.value="";
};

window.signOut = async () => {
    await fbSignOut(auth);
    currentUser=null;
    show('signIn');
};

/* LISTEN AUTH STATE */
onAuthStateChanged(auth,(user)=>{
    currentUser=user;
    if(user) show('dashboard');
    else show('signIn');
});

/* INCIDENTS */
onSnapshot(collection(db, "incidents"), (snapshot) => {
    incidents = [];
    snapshot.forEach(docSnap=>incidents.push({id:docSnap.id,...docSnap.data()}));
    render();
});

/* RESPONDERS */
onSnapshot(collection(db,"responders"),snapshot=>{
    responders = [];
    snapshot.forEach(docSnap=>responders.push({id:docSnap.id,...docSnap.data()}));
    renderRoster();
});

/* CREATE INCIDENT */
window.createIncident = async () => {
    if(!address.value || !description.value) return alert("Address and description required");
    await addDoc(collection(db,"incidents"),{
        address:address.value,
        description:description.value,
        contact:contact.value,
        priority:priority.value,
        responders:[],
        status:"Active",
        created:Date.now()
    });
    address.value=""; description.value=""; contact.value="";
};

/* UPDATE STATUS FOR A RESPONDER */
window.updateStatus = async (incidentId,status) => {
    if(!currentUser) return alert("Not signed in");
    const inc = incidents.find(i=>i.id===incidentId);
    if(!inc) return;
    let resp = inc.responders.find(r=>r.uid===currentUser.uid);
    if(!resp){
        resp = {uid:currentUser.uid,name:responders.find(r=>r.uid===currentUser.uid)?.name||"Responder",status:"Responding",start:Date.now(),elapsed:0};
        inc.responders.push(resp);
    }

    if(status==="Standing Off" || status==="Completed"){
        if(resp.start) resp.elapsed += Date.now() - resp.start;
        resp.start=null;
    } else {
        if(!resp.start) resp.start=Date.now();
    }
    resp.status=status;

    await updateDoc(doc(db,"incidents",incidentId),{responders:inc.responders,status:status==="Completed"?"Completed":"Active"});
    if(status==="Responding") document.getElementById("respondingSound").play();
    if(status==="Standing Off") document.getElementById("standingOffSound").play();
};

/* REMOVE INCIDENT */
window.removeIncident = async (id) => {
    await deleteDoc(doc(db,"incidents",id));
};

/* TIMER */
function formatTime(ms){
    const total=Math.floor(ms/1000);
    const m=Math.floor(total/60);
    const s=total%60;
    return `${m}m ${s}s`;
}

/* RENDER */
function render(){
    const activeDiv=document.getElementById("activeIncidents");
    const completedDiv=document.getElementById("completedIncidents");
    activeDiv.innerHTML="";
    completedDiv.innerHTML="";

    incidents.sort((a,b)=>b.created-a.created);

    incidents.forEach(i=>{
        let timerDisplay="",statusText="No Responder";
        let respEls="";
        i.responders.forEach(r=>{
            let total=r.elapsed||0;
            if(r.start) total += Date.now()-r.start;
            timerDisplay=`<div class="timer">Time: ${formatTime(total)}</div>`;
            statusText = r.status;
            respEls += `<div>${r.name} (${r.status})</div>`;
        });

        const mapUrl="https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(i.address);

        const card=`
        <div class="card">
            <b>${i.priority}</b> - <a href="${mapUrl}" target="_blank" class="mapLink">${i.address}</a><br>
            <span class="incDesc">${i.description}</span><br>
            Contact: ${i.contact||"N/A"}<br>
            ${respEls}
            ${timerDisplay}
            ${i.status!=="Completed"?`
            <div>
                <button class="action orange" onclick="updateStatus('${i.id}','Responding')">Responding</button>
                <button class="action blue" onclick="updateStatus('${i.id}','Busy')">Busy</button>
                <button class="action red" onclick="updateStatus('${i.id}','Standing Off')">Standing Off</button>
                <button class="action green" onclick="updateStatus('${i.id}','Completed')">Completed</button>
            </div>`:""}
            <button class="action closeBtn" onclick="removeIncident('${i.id}')">Remove</button>
        </div>
        `;

        if(i.status==="Completed") completedDiv.innerHTML+=card;
        else activeDiv.innerHTML+=card;
    });

    renderStats();
}

function renderRoster(){
    const div=document.getElementById("rosterList");
    div.innerHTML="";
    responders.forEach(r=>{
        div.innerHTML+=`<div class="card">${r.name} | ${r.vehicle} | ${r.status}</div>`;
    });
}

function renderStats(){
    const total=incidents.length;
    const active=incidents.filter(i=>i.status==="Active").length;
    const completed=incidents.filter(i=>i.status==="Completed").length;
    document.getElementById("statsContent").innerHTML=`
        <div class="statBox">Total Incidents: ${total}</div>
        <div class="statBox">Active Incidents: ${active}</div>
        <div class="statBox">Completed Incidents: ${completed}</div>
    `;
}

/* NAVIGATION */
window.show=function(id){
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    document.getElementById(id).style.display="block";
};

show("signIn");

</script>

</body>
</html>
