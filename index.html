<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Incident Command Center</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
    margin:0;
    font-family:Segoe UI;
    background:#0b1e35;
    color:white;
}

header{
    background:#132c4d;
    padding:15px;
    font-size:20px;
    text-align:center;
}

.container{
    display:flex;
    height:100vh;
}

.sidebar{
    width:220px;
    background:#132c4d;
    padding:10px;
    display:flex;
    flex-direction:column;
}

.sidebar button{
    width:100%;
    margin:6px 0;
    padding:12px;
    background:#1f3f66;
    border:none;
    color:white;
    cursor:pointer;
    font-size:15px;
    border-radius:6px;
}

.sidebar button:hover{
    background:#29598f;
}

.main{
    flex:1;
    padding:20px;
    overflow:auto;
}

.card{
    background:#1f3f66;
    padding:15px;
    margin:12px 0;
    border-radius:8px;
    line-height:1.5;
}

input,select{
    width:100%;
    padding:12px;
    margin:8px 0;
    font-size:16px;
    border-radius:6px;
    border:none;
}

button.action{
    padding:10px 14px;
    margin:6px 6px 6px 0;
    border:none;
    cursor:pointer;
    border-radius:6px;
    font-size:14px;
}

.orange{background:orange;color:white;}
.blue{background:#0099ff;color:white;}
.red{background:red;color:white;}
.green{background:green;color:white;}
.closeBtn{background:#444;color:white;}

.incDesc{
    color:#ff4444;
    font-weight:bold;
    font-size:16px;
}

.sectionTitle{
    margin-top:25px;
    border-bottom:1px solid #29598f;
    padding-bottom:6px;
}

a.mapLink{
    color:#00e5ff;
    font-weight:bold;
    text-decoration:none;
}

.timer{
    color:#00e5ff;
    font-weight:bold;
    margin-top:5px;
}

section{display:none;}

.statBox{
    background:#1f3f66;
    padding:20px;
    margin:15px 0;
    border-radius:8px;
    font-size:18px;
}

/* MOBILE */
@media (max-width:768px){
    .container{flex-direction:column;height:auto;}
    .sidebar{width:100%;flex-direction:row;}
    .sidebar button{flex:1;margin:4px;font-size:13px;padding:10px;}
}
</style>
</head>

<body>

<header>Dispatch Command Center OESF</header>

<div class="container">

<div class="sidebar">
<button onclick="show('dashboard')">Dashboard</button>
<button onclick="show('createIncident')">Create Incident</button>
<button onclick="show('statistics')">Statistics</button>
</div>

<div class="main">

<section id="dashboard">
<h2 class="sectionTitle">Active Incidents</h2>
<div id="activeIncidents"></div>

<h2 class="sectionTitle">Completed Incidents</h2>
<div id="completedIncidents"></div>
</section>

<section id="createIncident">
<h2>Create Incident</h2>
<input id="address" placeholder="Address">
<input id="description" placeholder="Description">
<input id="contact" placeholder="Contact On Scene">
<select id="priority">
<option>Low</option>
<option>Medium</option>
<option>High</option>
<option>Critical</option>
</select>
<button onclick="createIncident()">Create Incident</button>
</section>

<section id="statistics">
<h2>Incident Statistics</h2>
<div id="statsContent"></div>
</section>

</div>
</div>

<script>

let incidents=[];

/* STORAGE */
function saveData(){
    localStorage.setItem("incidentsData", JSON.stringify(incidents));
}
function loadData(){
    const data=localStorage.getItem("incidentsData");
    if(data){incidents=JSON.parse(data);}
}

/* NAV */
function show(id){
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    document.getElementById(id).style.display="block";
    if(id==="statistics"){renderStats();}
}

/* SOUND */
function playBeep(freq=600,duration=200){
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value=freq;
    osc.start();
    gain.gain.setValueAtTime(0.2,ctx.currentTime);
    osc.stop(ctx.currentTime+duration/1000);
}

/* CREATE */
function createIncident(){
    if(!address.value||!description.value){
        alert("Address and Description required");
        return;
    }

    incidents.unshift({
        id:Date.now(),
        address:address.value,
        description:description.value,
        contact:contact.value,
        priority:priority.value,
        status:"Active",
        responder:null
    });

    address.value="";
    description.value="";
    contact.value="";

    playBeep(800,250); // New incident sound

    saveData();
    render();
    show("dashboard");
}

/* UPDATE */
function updateStatus(id,status){
    const inc=incidents.find(i=>i.id===id);
    if(!inc)return;

    if(!inc.responder){
        inc.responder={status:status,start:Date.now(),elapsed:0};
    }

    if(status==="Standing Off"||status==="Completed"){
        if(inc.responder.start){
            inc.responder.elapsed+=Date.now()-inc.responder.start;
            inc.responder.start=null;
        }
    }else{
        if(!inc.responder.start){
            inc.responder.start=Date.now();
        }
    }

    inc.responder.status=status;

    if(status==="Completed"){inc.status="Completed";}

    playBeep(500,150); // Status change sound

    saveData();
    render();
}

/* REMOVE */
function removeIncident(id){
    incidents=incidents.filter(i=>i.id!==id);
    saveData();
    render();
}

/* TIMER */
function formatTime(ms){
    const total=Math.floor(ms/1000);
    const m=Math.floor(total/60);
    const s=total%60;
    return `${m}m ${s}s`;
}

/* RENDER */
function render(){
    const activeDiv=document.getElementById("activeIncidents");
    const completedDiv=document.getElementById("completedIncidents");
    activeDiv.innerHTML="";
    completedDiv.innerHTML="";

    incidents.forEach(i=>{
        const mapUrl="https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(i.address);
        let timerDisplay="";
        let statusText="Not Assigned";

        if(i.responder){
            let total=i.responder.elapsed;
            if(i.responder.start){total+=Date.now()-i.responder.start;}
            timerDisplay=`<div class="timer">Time: ${formatTime(total)}</div>`;
            statusText=i.responder.status;
        }

        const card=`
        <div class="card">
            <b>${i.priority}</b> -
            <a href="${mapUrl}" target="_blank" class="mapLink">${i.address}</a><br>
            <span class="incDesc">${i.description}</span><br>
            Contact: ${i.contact||"N/A"}<br>
            Status: ${statusText}
            ${timerDisplay}

            ${i.status!=="Completed"?`
            <div>
                <button class="action orange" onclick="updateStatus(${i.id},'Responding')">Responding</button>
                <button class="action blue" onclick="updateStatus(${i.id},'Busy')">Busy</button>
                <button class="action red" onclick="updateStatus(${i.id},'Standing Off')">Standing Off</button>
                <button class="action green" onclick="updateStatus(${i.id},'Completed')">Completed</button>
            </div>`:""}

            <br>
            <button class="action closeBtn" onclick="removeIncident(${i.id})">Remove</button>
        </div>
        `;

        if(i.status==="Completed"){completedDiv.innerHTML+=card;}
        else{activeDiv.innerHTML+=card;}
    });
}

/* STATISTICS */
function renderStats(){
    const total=incidents.length;
    const active=incidents.filter(i=>i.status==="Active").length;
    const completed=incidents.filter(i=>i.status==="Completed").length;

    let totalTime=0;
    let count=0;

    incidents.forEach(i=>{
        if(i.status==="Completed"&&i.responder){
            totalTime+=i.responder.elapsed;
            count++;
        }
    });

    const avg=count?formatTime(totalTime/count):"N/A";

    document.getElementById("statsContent").innerHTML=`
        <div class="statBox">Total Incidents: ${total}</div>
        <div class="statBox">Active Incidents: ${active}</div>
        <div class="statBox">Completed Incidents: ${completed}</div>
        <div class="statBox">Average Response Time: ${avg}</div>
    `;
}

setInterval(render,1000);

loadData();
show("dashboard");
render();

</script>

</body>
</html>
