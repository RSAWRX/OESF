<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Emergency Dispatch</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Segoe UI;background:#0b1e35;color:white}
header{background:#132c4d;padding:15px;font-size:20px}
.container{display:flex;height:100vh}
.sidebar{width:240px;background:#132c4d;padding:10px}
.sidebar button{width:100%;margin:5px 0;padding:10px;background:#1f3f66;border:none;color:white;cursor:pointer}
.sidebar button:hover{background:#29598f}
.main{flex:1;padding:20px;overflow:auto}
.card{background:#1f3f66;padding:12px;margin:10px 0;border-radius:6px}
input,select{width:100%;padding:8px;margin:6px 0}
button.action{background:#0074D9;color:white;border:none;padding:6px 10px;margin:3px 2px;cursor:pointer}
.sectionTitle{margin-top:25px;border-bottom:1px solid #29598f;padding-bottom:5px}
.timer{color:#00e5ff;font-weight:bold}
.commander{color:#ffcc00;font-weight:bold}
</style>
</head>

<body>

<header>ðŸš¨ Emergency Dispatch System</header>

<div class="container">

<div class="sidebar">
<button onclick="show('dashboard')">Dashboard</button>
<button onclick="show('createIncident')">Create Incident</button>
<button onclick="show('roster')">OnDuty Roster</button>
<button id="signinBtn" onclick="show('login')">Sign In</button>
</div>

<div class="main">

<section id="login">
<h2>Responder Sign In</h2>
<input id="name" placeholder="Responder Name">
<input id="vehicleMakeModel" placeholder="Vehicle Make & Model">
<input id="vehicleColour" placeholder="Vehicle Colour">
<input id="registration" placeholder="Vehicle Registration">
<button class="action" onclick="signIn()">Sign In</button>
</section>

<section id="dashboard" style="display:none">
<h2>Live Dashboard</h2>
<div class="sectionTitle">Active Incidents</div>
<div id="incidentBoard"></div>
<div class="sectionTitle">OnDuty Roster</div>
<div id="rosterBoard"></div>
</section>

<section id="createIncident" style="display:none">
<h2>Create Incident</h2>
<input id="address" placeholder="Incident Address">
<input id="description" placeholder="Incident Description">
<input id="contact" placeholder="Contact On Scene">
<select id="priority">
<option>Low</option>
<option>Medium</option>
<option>High</option>
<option>Critical</option>
</select>
<button class="action" onclick="createIncident()">Create Incident</button>
</section>

<section id="roster" style="display:none">
<h2>OnDuty Roster</h2>
<div id="rosterList"></div>
</section>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, getDocs, query, where, getDoc }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ðŸ”´ INSERT YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCcbMg_BxDkvCFPvzyC_qDxr5tmb3IRhzk",
    authDomain: "oesf-e7a8e.firebaseapp.com",
    projectId: "oesf-e7a8e",
    storageBucket: "oesf-e7a8e.firebasestorage.app",
    messagingSenderId: "844363489759",
    appId: "1:844363489759:web:2b56fe51cc28053dbe246a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser=null;
let incidentsCache=[];

/* Navigation */
window.show=function(id){
document.querySelectorAll("section").forEach(s=>s.style.display="none");
document.getElementById(id).style.display="block";
}

/* SIGN IN */
window.signIn=async function(){

if(!name.value||!vehicleMakeModel.value||!vehicleColour.value||!registration.value){
alert("Complete all fields.");
return;
}

const q=query(collection(db,"units"), where("registration","==",registration.value));
const snap=await getDocs(q);

if(!snap.empty){
alert("Vehicle already signed in.");
return;
}

currentUser={
name:name.value,
vehicleMakeModel:vehicleMakeModel.value,
vehicleColour:vehicleColour.value,
registration:registration.value,
status:"Available"
};

await addDoc(collection(db,"units"),currentUser);

document.getElementById("signinBtn").style.display="none";
show("dashboard");
}

/* CREATE INCIDENT */
window.createIncident=async function(){

if(!address.value||!description.value||!contact.value){
alert("Complete all fields.");
return;
}

await addDoc(collection(db,"incidents"),{
address:address.value,
description:description.value,
contact:contact.value,
priority:priority.value,
created:Date.now(),
responders:[],
commander:null
});

alert("Incident Created.");
show("dashboard");
}

/* ADD RESPONDER */
window.addResponder=async function(id){

const incidentRef=doc(db,"incidents",id);
const snap=await getDoc(incidentRef);
const data=snap.data();

if(data.responders.find(r=>r.registration===currentUser.registration)) return;

let responders=data.responders;

responders.push({
registration:currentUser.registration,
name:currentUser.name,
status:"Responding"
});

await updateDoc(incidentRef,{responders:responders});
}

/* UPDATE STATUS */
window.updateResponderStatus=async function(id,newStatus){

const incidentRef=doc(db,"incidents",id);
const snap=await getDoc(incidentRef);
const data=snap.data();

let responders=data.responders;
let commander=data.commander;

responders=responders.map(r=>{
if(r.registration===currentUser.registration){

if(newStatus==="On Scene" && !commander){
commander=currentUser.registration;
}

return {...r,status:newStatus};
}
return r;
});

await updateDoc(incidentRef,{
responders:responders,
commander:commander
});
}

/* LIVE INCIDENT LISTENER */
onSnapshot(collection(db,"incidents"),snapshot=>{
incidentsCache=[];
snapshot.forEach(docSnap=>{
incidentsCache.push({id:docSnap.id,...docSnap.data()});
});
renderIncidents();
});

/* TIMER RENDER LOOP */
setInterval(renderIncidents,1000);

function renderIncidents(){

const div=document.getElementById("incidentBoard");
if(!div) return;

div.innerHTML="";

incidentsCache.forEach(data=>{

let diff=Math.floor((Date.now()-data.created)/1000);
let m=Math.floor(diff/60).toString().padStart(2,"0");
let s=(diff%60).toString().padStart(2,"0");

let respondersHTML="None";

if(data.responders.length>0){
respondersHTML="";
data.responders.forEach(r=>{
respondersHTML+=`
${r.name} (${r.registration}) - ${r.status}
${data.commander===r.registration?'<span class="commander"> - Commander</span>':""}
<br>`;
});
}

div.innerHTML+=`
<div class="card">
<b>${data.priority}</b><br>
Description: ${data.description}<br>
Address: ${data.address}<br>
Contact On Scene: ${data.contact}<br>
Time Elapsed: <span class="timer">${m}:${s}</span><br>
Responders:<br>${respondersHTML}
<br>
${currentUser && !data.responders.find(r=>r.registration===currentUser.registration)
? `<button class="action" onclick="addResponder('${data.id}')">Respond</button>`:""}

${currentUser && data.responders.find(r=>r.registration===currentUser.registration)
? `
<button class="action" onclick="updateResponderStatus('${data.id}','Responding')">Responding</button>
<button class="action" onclick="updateResponderStatus('${data.id}','On Scene')">On Scene</button>
<button class="action" onclick="updateResponderStatus('${data.id}','Busy')">Busy</button>
<button class="action" onclick="updateResponderStatus('${data.id}','Completed')">Completed</button>
`:""}
</div>`;
});
}

/* LIVE ROSTER */
onSnapshot(collection(db,"units"),snapshot=>{
const dash=document.getElementById("rosterBoard");
const roster=document.getElementById("rosterList");

dash.innerHTML="";
roster.innerHTML="";

snapshot.forEach(doc=>{
const u=doc.data();
let card=`
<div class="card">
<b>${u.name}</b><br>
Vehicle: ${u.vehicleMakeModel}<br>
Colour: ${u.vehicleColour}<br>
Registration: ${u.registration}<br>
Status: ${u.status}
</div>`;

dash.innerHTML+=card;
roster.innerHTML+=card;
});
});

show("login");

</script>
</body>
</html>
