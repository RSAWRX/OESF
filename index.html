<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dispatch Command Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
:root{
--bg:#001f3f;
--panel:#00264d;
--card:#003366;
--text:white;
}
body{
margin:0;font-family:Segoe UI,Arial;background:var(--bg);color:var(--text);
}
.header{
position:sticky;top:0;display:flex;align-items:center;
background:var(--panel);padding:10px 20px;z-index:100;
border-bottom:2px solid #004080;
}
.header h1{margin:0;font-size:22px;}
.header #clock{margin-left:auto;}
.container{display:flex;height:calc(100vh - 60px);}
.sidebar{
width:240px;background:var(--panel);display:flex;flex-direction:column;
}
.sidebar button{
padding:16px;border:none;background:none;color:inherit;
text-align:left;font-size:16px;cursor:pointer;
border-bottom:1px solid #004080;
}
.sidebar button:hover{background:#004080;}
.main{flex:1;padding:20px;overflow-y:auto;}
section{display:none;}
section.active{display:block;}
.card{
background:var(--card);padding:14px;border-radius:10px;margin:10px 0;
}
input,select,textarea{width:100%;padding:8px;margin:5px 0;border-radius:4px;border:none;}
button.action{padding:10px 14px;background:#0074D9;color:white;border:none;border-radius:5px;cursor:pointer;margin-top:6px;}
button.action:hover{background:#005fa3;}
.status-btn{padding:6px 10px;border:none;border-radius:4px;margin:3px;color:white;cursor:pointer;}
.Responding{background:orange;color:white;}
.Busy{background:yellow;color:black;}
.StandingOff{background:#0d47a1;color:white;} /* dark blue */
.Completed{background:green;color:white;}
.write-report{background:white;color:black;}
.critical{animation:blink 1s infinite;}
@keyframes blink{0%,50%,100%{opacity:1;}25%,75%{opacity:0;}}
.timer{font-size:20px;font-weight:bold;padding:4px 8px;border-radius:6px;display:inline-block;margin:5px 0;}
.sev-Low{background:#2ecc71;padding:4px;border-radius:4px;}
.sev-Medium{background:#f1c40f;color:black;padding:4px;border-radius:4px;}
.sev-High{background:#e67e22;padding:4px;border-radius:4px;}
.sev-Critical{background:#e74c3c;padding:4px;border-radius:4px;color:white;}
</style>
</head>
<body>

<div class="header">
<h1>Dispatch Command Control</h1>
<div id="clock"></div>
</div>

<div class="container">

<div class="sidebar">
<button onclick="show('dashboard')">Dashboard</button>
<button onclick="show('createIncident')">Dispatch Incident</button>
<button onclick="show('completedIncidents')">Completed Incidents</button>
</div>

<div class="main">

<section id="dashboard">
<h2>Current Incidents</h2>
<div id="dashboardIncidents"></div>
</section>

<section id="createIncident">
<h2>Dispatch Incident</h2>
<input id="incidentAddress" placeholder="Address">
<input id="incidentDescription" placeholder="Description">
<select id="incidentPriority">
<option>Low</option><option>Medium</option>
<option>High</option><option>Critical</option>
</select>
<input id="incidentCOS" placeholder="Contact On Scene">
<button class="action" onclick="addIncident()">Create Incident</button>
</section>

<section id="completedIncidents">
<h2>Completed Incidents</h2>
<div id="completedList"></div>
</section>

</div>
</div>

<audio id="newIncidentSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>
<audio id="standingOffSound" src="https://www.soundjay.com/button/button-09.wav"></audio>
<audio id="completedSound" src="https://www.soundjay.com/button/button-10.wav"></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

<script>
// TODO: Paste your Firebase config here
const firebaseConfig = {
  apiKey: "AIzaSyCcbMg_BxDkvCFPvzyC_qDxr5tmb3IRhzk",
    authDomain: "oesf-e7a8e.firebaseapp.com",
    projectId: "oesf-e7a8e",
    storageBucket: "oesf-e7a8e.firebasestorage.app",
    messagingSenderId: "844363489759",
    appId: "1:844363489759:web:2b56fe51cc28053dbe246a",
    measurementId: "G-CMZHVSVG8Z"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentFilter = "";

function show(id){
document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
}

function updateClock(){
const now = new Date();
document.getElementById("clock").innerText = now.toLocaleString();
}
setInterval(updateClock,1000);
updateClock();

// Timer helper
function formatTime(ms){
let sec=Math.floor(ms/1000)%60;
let min=Math.floor(ms/60000)%60;
let hr=Math.floor(ms/3600000);
return `${hr.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}

// Add Incident
async function addIncident(){
const docRef = await db.collection("incidents").add({
address:incidentAddress.value,
description:incidentDescription.value,
priority:incidentPriority.value,
cos:incidentCOS.value,
status:"Responding",
startTime:Date.now(),
totalElapsed:0
});
document.getElementById("newIncidentSound").play();
if (navigator.vibrate){navigator.vibrate(200);}
incidentAddress.value="";incidentDescription.value="";incidentCOS.value="";
}

// Render incidents
function renderIncidents(){
const dash = document.getElementById("dashboardIncidents");
const comp = document.getElementById("completedList");
dash.innerHTML=""; comp.innerHTML="";
db.collection("incidents").orderBy("startTime","desc")
.onSnapshot(snapshot=>{
dash.innerHTML=""; comp.innerHTML="";
snapshot.forEach(docSnap=>{
const i = docSnap.data();
const id = docSnap.id;
const elapsed = i.status==="StandingOff"||i.status==="Completed"?i.totalElapsed:Date.now()-i.startTime;
const timerText = formatTime(elapsed);
let card = document.createElement("div");
card.className="card";
let priorityClass = "sev-"+i.priority;
let descStyle = i.description?"color:darkred;font-weight:bold;":"";
let criticalClass = i.priority==="Critical"?"critical":"";
let html = `<b>${i.address}</b> <span class="${priorityClass} ${criticalClass}">${i.priority}</span><br>
<b style="${descStyle}">${i.description}</b><br>
COS: ${i.cos}<br>
<span class="timer">${timerText}</span><br>
<button class="status-btn Responding" onclick="updateStatus('${id}','Responding')">Responding</button>
<button class="status-btn Busy" onclick="updateStatus('${id}','Busy')">Busy</button>
<button class="status-btn StandingOff" onclick="updateStatus('${id}','StandingOff')">Standing Off</button>
<button class="status-btn Completed" onclick="updateStatus('${id}','Completed')">Completed</button>
<button class="write-report" onclick="openReport('${id}')">Write Report</button>
<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.address)}" target="_blank" style="background:#66b3ff;padding:3px;border-radius:3px;color:white;text-decoration:none;">Open Map</a>
`;
card.innerHTML=html;
if(i.status==="Completed"){comp.appendChild(card);}else{dash.appendChild(card);}
});
});
}

// Update status
async function updateStatus(id,status){
const docRef = db.collection("incidents").doc(id);
const docSnap = await docRef.get();
if(!docSnap.exists()) return;
const data = docSnap.data();
let elapsed = data.totalElapsed;
if(status==="StandingOff"||status==="Completed"){
elapsed += Date.now()-data.startTime;
if(status==="StandingOff"){document.getElementById("standingOffSound").play();}
if(status==="Completed"){document.getElementById("completedSound").play();}
}
await docRef.update({
status,
totalElapsed:elapsed,
startTime:status==="Responding"||status==="Busy"?Date.now():data.startTime
});
}

// Write report
function openReport(id){
let report = prompt("Enter report for this incident:");
if(report!==null){
db.collection("incidents").doc(id).update({report});
alert("Report saved.");
show("dashboard");
}
}

renderIncidents();
show("dashboard");
</script>
</body>
</html>
