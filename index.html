<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch Command Control</title>

<style>
body{
font-family:Arial;
margin:0;
background:#f4f6f9;
}

header{
background:#1e3a5f;
color:white;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
font-size:18px;
}

.container{
padding:15px;
}

button{
padding:10px;
margin:5px 5px 10px 0;
border:none;
border-radius:6px;
cursor:pointer;
font-weight:bold;
}

.nav-btn{background:#1e3a5f;color:white;}
.clear-btn{background:#444;color:white;}

.card{
background:white;
padding:15px;
margin-bottom:15px;
border-radius:8px;
box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

.description{
color:darkred;
font-weight:bold;
}

.status-label{
font-weight:bold;
}

.map-link{
display:inline-block;
background:#e6f0ff;
padding:6px 10px;
border-radius:6px;
text-decoration:none;
margin-top:5px;
}

.status-btn{
margin-top:5px;
}

.Responding{background:orange;color:white;}
.Busy{background:yellow;color:black;}
.StandingOff{background:#0d47a1;color:white;} /* dark blue */
.Completed{background:#4CAF50;color:white;}
.write-report{background:white;color:black;}

textarea{
margin-top:5px;
padding:6px;
border-radius:4px;
border:1px solid #ccc;
}

@media(max-width:600px){
button{width:100%;}
textarea{width:100%;}
}
</style>
</head>
<body>

<header>
<div>Dispatch Command Control</div>
<div id="dateTime"></div>
</header>

<div class="container">

<!-- Navigation -->
<button class="nav-btn" onclick="showDashboard()">Dashboard</button>
<button class="nav-btn" onclick="showDispatch()">Dispatch Incident</button>
<button class="nav-btn" onclick="showCompletedPage()">Completed Incidents</button>
<button class="clear-btn" onclick="clearCompleted()">Clear Completed</button>

<!-- Dashboard Page (default) -->
<div id="dashboardPage">
<h3>Active Incidents</h3>
<div id="activeList"></div>
</div>

<!-- Dispatch Page -->
<div id="dispatchPage" style="display:none;">
<h3>Dispatch Incident</h3>
<input id="address" placeholder="Address" style="width:100%;padding:8px;margin-bottom:8px;">
<input id="description" placeholder="Description" style="width:100%;padding:8px;margin-bottom:8px;">
<select id="priority" style="width:100%;padding:8px;margin-bottom:8px;">
<option>Low</option>
<option>Medium</option>
<option>High</option>
<option>Critical</option>
</select>
<input id="cos" placeholder="COS Name" style="width:100%;padding:8px;margin-bottom:8px;">
<button onclick="addIncident()">Create Incident</button>
</div>

<!-- Completed Incidents Page -->
<div id="completedPage" style="display:none;">
<h3>Completed Incidents</h3>
<div id="completedList"></div>
</div>

</div>

<!-- AUDIO -->
<audio id="alarmSound">
<source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<audio id="standOffChime">
<source src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" type="audio/ogg">
</audio>

<audio id="completedSound">
<source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
</audio>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
 apiKey: "AIzaSyCcbMg_BxDkvCFPvzyC_qDxr5tmb3IRhzk",
    authDomain: "oesf-e7a8e.firebaseapp.com",
    projectId: "oesf-e7a8e",
    storageBucket: "oesf-e7a8e.firebasestorage.app",
    messagingSenderId: "844363489759",
    appId: "1:844363489759:web:2b56fe51cc28053dbe246a",
    measurementId: "G-CMZHVSVG8Z"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const incidentsRef = collection(db,"incidents");

// --- Page Navigation ---
window.showDashboard = function(){
document.getElementById("dashboardPage").style.display="block";
document.getElementById("dispatchPage").style.display="none";
document.getElementById("completedPage").style.display="none";
}

window.showDispatch = function(){
document.getElementById("dashboardPage").style.display="none";
document.getElementById("dispatchPage").style.display="block";
document.getElementById("completedPage").style.display="none";
}

window.showCompletedPage = function(){
document.getElementById("dashboardPage").style.display="none";
document.getElementById("dispatchPage").style.display="none";
document.getElementById("completedPage").style.display="block";
}

// --- Add Incident ---
window.addIncident=async function(){
const address=document.getElementById("address").value;
const description=document.getElementById("description").value;
const priority=document.getElementById("priority").value;
const cos=document.getElementById("cos").value;

await addDoc(incidentsRef,{
address,
description,
priority,
cos,
status:"No Response",
startTime:Date.now(),
timerStopped:false,
totalElapsed:0,
completedTime:null,
report:""
});

// ðŸ”” Alarm
document.getElementById("alarmSound").volume=1.0;
document.getElementById("alarmSound").play();

// ðŸ“³ Vibrate mobile
if(navigator.vibrate){navigator.vibrate([300,150,300,150,500]);}

document.getElementById("dispatchPage").style.display="none";
showDashboard();
}

// --- Set Status ---
window.setStatus=async function(id,status){
const incidentDoc = doc(db,"incidents",id);
const snap = await incidentDoc.get();
const data = snap.data();
let elapsed = data.totalElapsed;

// Map status names
let newStatus = data.status;
if(status==="Responding") newStatus="Responding";
if(status==="StandingOff") newStatus="Standing Off";
if(status==="Busy") newStatus="Not Available";
if(status==="Completed") newStatus="Completed";

// Stop timer only if Standing Off or Completed
if(status==="StandingOff" || status==="Completed"){
if(!data.timerStopped){
elapsed += Date.now() - data.startTime;
}
await updateDoc(incidentDoc,{
status:newStatus,
timerStopped:true,
totalElapsed:elapsed,
completedTime:status==="Completed"?Date.now():data.completedTime
});
// Play sounds
if(status==="StandingOff"){document.getElementById("standOffChime").play();}
if(status==="Completed"){document.getElementById("completedSound").play();}
}else{
await updateDoc(incidentDoc,{status:newStatus});
}
}

// --- Report Editing ---
window.saveReport=async function(id){
const reportText = document.getElementById("report-"+id).value;
await updateDoc(doc(db,"incidents",id),{report:reportText});
alert("Report saved.");
}

// --- Clear Completed ---
window.clearCompleted=async function(){
onSnapshot(incidentsRef,(snapshot)=>{
snapshot.forEach(docSnap=>{
if(docSnap.data().status==="Completed"){
deleteDoc(doc(db,"incidents",docSnap.id));
}
});
});
}

// --- Format Time ---
function formatTime(ms){
let seconds=Math.floor(ms/1000);
let h=Math.floor(seconds/3600);
let m=Math.floor((seconds%3600)/60);
let s=seconds%60;
return `${h}h ${m}m ${s}s`;
}

// --- Render Incidents Live ---
let previousStatuses={};
onSnapshot(incidentsRef,(snapshot)=>{
let activeHTML="";
let completedHTML="";

// Sort newest first
const docs = snapshot.docs.sort((a,b)=>b.data().startTime - a.data().startTime);

docs.forEach(docSnap=>{
const i=docSnap.data();
const id=docSnap.id;
const elapsed=i.timerStopped?i.totalElapsed:(Date.now()-i.startTime + i.totalElapsed);

// Status change sounds
if(previousStatuses[id] && previousStatuses[id]!==i.status){
if(i.status==="Standing Off"){document.getElementById("standOffChime").play();}
if(i.status==="Completed"){document.getElementById("completedSound").play();}
}
previousStatuses[id]=i.status;

let card=`<div class="card">
<b>${i.address}</b><br>
<span class="description">${i.description}</span><br>
Priority: ${i.priority}<br>
COS: ${i.cos}<br>
<span class="status-label">Status: ${i.status}</span><br>
Created: ${new Date(i.startTime).toLocaleString()}<br>
${i.completedTime?`Completed: ${new Date(i.completedTime).toLocaleString()}<br>`:""}
Time: ${formatTime(elapsed)}<br>
<a class="map-link" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.address)}">Open Map</a><br>
`;

if(i.status!=="Completed"){
card+=`
<button class="status-btn Responding" onclick="setStatus('${id}','Responding')">Responding</button>
<button class="status-btn Busy" onclick="setStatus('${id}','Busy')">Busy</button>
<button class="status-btn StandingOff" onclick="setStatus('${id}','StandingOff')">Standing Off</button>
<button class="status-btn Completed" onclick="setStatus('${id}','Completed')">Completed</button>
<button class="write-report" onclick="document.getElementById('report-${id}').style.display='block'">Write Report</button>
<textarea id="report-${id}" style="width:100%;display:none;margin-top:5px;">${i.report}</textarea>
<button class="write-report" onclick="saveReport('${id}')">Save Report</button>
`;
activeHTML+=card+"</div>";
}else{
card+=`<textarea style="width:100%;margin-top:5px;" readonly>${i.report}</textarea>`;
completedHTML+=card+"</div>";
}
});

document.getElementById("activeList").innerHTML=activeHTML;
document.getElementById("completedList").innerHTML=completedHTML;
});

// --- Live Clock ---
setInterval(()=>{
const now=new Date();
document.getElementById("dateTime").innerText=now.toLocaleString();
},1000);

</script>
</body>
</html>
