<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Emergency Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#001f3f;color:white;}
.header{background:#00264d;padding:10px;display:flex;justify-content:space-between;align-items:center;}
.container{display:flex;height:calc(100vh - 60px);}
.sidebar{width:220px;background:#00264d;display:flex;flex-direction:column;}
.sidebar button{padding:14px;border:none;background:none;color:white;text-align:left;cursor:pointer;border-bottom:1px solid #004080;font-size:15px;}
.sidebar button:hover{background:#004080;}
.main{flex:1;padding:15px;overflow-y:auto;}
section{display:none;}
section.active{display:block;}
.card{background:#003366;padding:12px;border-radius:8px;margin:12px 0;}
.status-btn{margin:6px 6px 6px 0;padding:6px 10px;border:none;border-radius:6px;color:white;cursor:pointer;}
.Responding{background:orange;}
.Busy{background:blue;}
.StandingOff{background:red;}
.Completed{background:green;}
.map-link{display:inline-block;background:#0074D9;color:white;padding:6px 10px;border-radius:6px;text-decoration:none;margin:6px 0;}
input,select,textarea,button.action{width:100%;margin:6px 0;padding:8px;box-sizing:border-box;}
textarea{min-height:120px;}
button.action{border-radius:6px;cursor:pointer;}
.clear-btn{background:#8B0000;color:white;margin-bottom:15px;}

@media(max-width:768px){
.container{flex-direction:column;}
.sidebar{width:100%;flex-direction:row;}
.sidebar button{flex:1;font-size:13px;padding:10px;}
}
</style>
</head>

<body>

<div class="header">
<h2>Emergency Operations Dashboard</h2>
<div id="clock"></div>
</div>

<div class="container">

<div class="sidebar">
<button onclick="show('add')">Dispatch Incident</button>
<button onclick="show('active')">Active Incidents</button>
<button onclick="show('completed')">Completed Incidents</button>
</div>

<div class="main">

<section id="add">
<h3>Dispatch Incident</h3>
<input id="address" placeholder="Address">
<input id="description" placeholder="Description">
<select id="priority">
<option>Low</option>
<option>Medium</option>
<option>High</option>
<option>Critical</option>
</select>
<input id="cos" placeholder="Contact On Scene">
<button class="action" onclick="addIncident()">Dispatch</button>
</section>

<section id="active">
<h3>Active Incidents</h3>
<div id="activeList"></div>
</section>

<section id="completed">
<h3>Completed Incidents</h3>

<button class="action clear-btn" onclick="clearCompleted()">
Clear Completed Incidents
</button>

<div id="completedList"></div>
</section>

<section id="report">
<h3>Incident Report</h3>
<div id="reportInfo"></div>
<textarea id="reportText" placeholder="Write detailed report..."></textarea>
<button class="action" onclick="submitReport()">Submit Report</button>
</section>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, onSnapshot,
  doc, updateDoc, serverTimestamp,
  getDocs, deleteDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCcbMg_BxDkvCFPvzyC_qDxr5tmb3IRhzk",
    authDomain: "oesf-e7a8e.firebaseapp.com",
    projectId: "oesf-e7a8e",
    storageBucket: "oesf-e7a8e.firebasestorage.app",
    messagingSenderId: "844363489759",
    appId: "1:844363489759:web:2b56fe51cc28053dbe246a",
    measurementId: "G-CMZHVSVG8Z"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const incidentsRef = collection(db, "incidents");

let activeReportId = null;

// CLOCK
setInterval(()=> {
document.getElementById("clock").innerText=new Date().toLocaleString();
},1000);

// NAVIGATION
window.show=function(id){
document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
};
show("add");

// FORMAT TIME
function formatTime(ms){
let sec=Math.floor(ms/1000);
let h=Math.floor(sec/3600);
let m=Math.floor((sec%3600)/60);
let s=sec%60;
return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ADD INCIDENT
window.addIncident=async function(){
const address=document.getElementById("address").value.trim();
const description=document.getElementById("description").value.trim();
const priority=document.getElementById("priority").value;
const cos=document.getElementById("cos").value.trim();

if(!address||!description||!cos){alert("Fill all fields");return;}

await addDoc(incidentsRef,{
address,description,priority,cos,
status:"Responding",
startTime:Date.now(),
totalElapsed:0,
timerStopped:false,
report:null,
created:serverTimestamp()
});

document.getElementById("address").value="";
document.getElementById("description").value="";
document.getElementById("cos").value="";
show("active");
};

// REALTIME LISTENER
onSnapshot(incidentsRef,(snapshot)=>{
let activeHTML="";
let completedHTML="";

snapshot.forEach(docSnap=>{
const i=docSnap.data();
const id=docSnap.id;

let elapsed=i.totalElapsed;
if(!i.timerStopped){
elapsed+=Date.now()-i.startTime;
}

let card=`
<div class="card">
<b>${i.address}</b><br>
${i.description}<br>
Priority: ${i.priority}<br>
COS: ${i.cos}<br>
Time: ${formatTime(elapsed)}<br>
<a class="map-link" target="_blank"
href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.address)}">
Open Map</a><br>
`;

if(i.status!=="Completed"){
card+=`
<button class="status-btn Responding" onclick="setStatus('${id}','Responding')">Responding</button>
<button class="status-btn Busy" onclick="setStatus('${id}','Busy')">Busy</button>
<button class="status-btn StandingOff" onclick="stopTimer('${id}','StandingOff')">Standing Off</button>
<button class="status-btn Completed" onclick="stopTimer('${id}','Completed')">Completed</button>
<button class="status-btn Completed" onclick="openReport('${id}')">Write Report</button>
`;
card+="</div>";
activeHTML+=card;
}else{
card+=i.report?`<b>Report:</b><br>${i.report}`:"";
card+="</div>";
completedHTML+=card;
}
});

document.getElementById("activeList").innerHTML=activeHTML;
document.getElementById("completedList").innerHTML=completedHTML;
});

// STATUS UPDATE
window.setStatus=async function(id,status){
await updateDoc(doc(db,"incidents",id),{status});
};

// STOP TIMER
window.stopTimer=async function(id,status){
await updateDoc(doc(db,"incidents",id),{
status,
timerStopped:true,
totalElapsed:Date.now()
});
};

// REPORT
window.openReport=function(id){
activeReportId=id;
document.getElementById("reportInfo").innerHTML="Write report for incident:";
show("report");
};

window.submitReport=async function(){
const text=document.getElementById("reportText").value.trim();
if(!text){alert("Write report first");return;}
await updateDoc(doc(db,"incidents",activeReportId),{report:text});
document.getElementById("reportText").value="";
show("active");
};

// CLEAR COMPLETED
window.clearCompleted=async function(){
if(!confirm("Are you sure you want to clear ALL completed incidents?")) return;

const snapshot=await getDocs(incidentsRef);
for(const docSnap of snapshot.docs){
if(docSnap.data().status==="Completed"){
await deleteDoc(doc(db,"incidents",docSnap.id));
}
}
};

</script>

</body>
</html>
