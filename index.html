<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch Command Control</title>

<style>
body{
font-family:Arial;
margin:0;
background:#0b1f3a; /* Navy Blue */
color:white;
}

header{
background:#1e3a5f; /* KEEP SAME */
color:white;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
font-size:18px;
}

.container{
padding:15px;
}

button{
padding:10px;
margin:6px 6px 12px 0;
border:none;
border-radius:6px;
cursor:pointer;
font-weight:bold;
}

.nav-btn{background:#1e3a5f;color:white;}
.clear-btn{background:#444;color:white;}

.card{
background:white;
color:black;
padding:15px;
margin-bottom:15px;
border-radius:8px;
box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

.description{
color:darkred;
font-weight:bold;
}

.status-label{
font-weight:bold;
}

.map-link{
display:inline-block;
background:#e6f0ff;
padding:6px 10px;
border-radius:6px;
text-decoration:none;
margin-top:5px;
}

.Responding{background:orange;color:white;}
.Busy{background:#ff9800;color:white;}
.StandingOff{background:lightblue;color:black;}
.Completed{background:#4CAF50;color:white;}

@media(max-width:600px){
button{width:100%;}
}
</style>
</head>
<body>

<header>
<div>ðŸš¨ Dispatch Command Control</div>
<div id="dateTime"></div>
</header>

<div class="container">

<button class="nav-btn" onclick="showDashboard()">Dashboard</button>
<button class="nav-btn" onclick="showDispatch()">Dispatch Incident</button>
<button class="nav-btn" onclick="showCompleted()">Completed Incidents</button>

<div id="dashboardPage">
<h3>Current Incidents</h3>
<div id="activeList"></div>
</div>

<div id="dispatchPage" style="display:none;">
<h3>Dispatch Incident</h3>
<input id="address" placeholder="Address" style="width:100%;padding:8px;margin-bottom:8px;">
<input id="description" placeholder="Description" style="width:100%;padding:8px;margin-bottom:8px;">
<select id="priority" style="width:100%;padding:8px;margin-bottom:8px;">
<option>Low</option>
<option>Medium</option>
<option>High</option>
<option>Critical</option>
</select>
<input id="cos" placeholder="COS Name" style="width:100%;padding:8px;margin-bottom:8px;">
<button onclick="addIncident()">Create Incident</button>
</div>

<div id="completedPage" style="display:none;">
<h3>Completed Incidents</h3>
<button class="clear-btn" onclick="clearCompleted()">Clear Completed</button>
<div id="completedList"></div>
</div>

</div>

<!-- AUDIO -->
<audio id="alarmSound">
<source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<audio id="standOffChime">
<source src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" type="audio/ogg">
</audio>

<audio id="completedSound">
<source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
</audio>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyCcbMg_BxDkvCFPvzyC_qDxr5tmb3IRhzk",
    authDomain: "oesf-e7a8e.firebaseapp.com",
    projectId: "oesf-e7a8e",
    storageBucket: "oesf-e7a8e.firebasestorage.app",
    messagingSenderId: "844363489759",
    appId: "1:844363489759:web:2b56fe51cc28053dbe246a",
    measurementId: "G-CMZHVSVG8Z"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const incidentsRef = collection(db,"incidents");
const q = query(incidentsRef, orderBy("startTime","desc")); // NEWEST FIRST

// PAGE NAV
window.showDashboard=function(){
dashboardPage.style.display="block";
dispatchPage.style.display="none";
completedPage.style.display="none";
}
window.showDispatch=function(){
dashboardPage.style.display="none";
dispatchPage.style.display="block";
completedPage.style.display="none";
}
window.showCompleted=function(){
dashboardPage.style.display="none";
dispatchPage.style.display="none";
completedPage.style.display="block";
}

// ADD INCIDENT
window.addIncident=async function(){
await addDoc(incidentsRef,{
address:address.value,
description:description.value,
priority:priority.value,
cos:cos.value,
status:"Responding",
startTime:Date.now(),
timerStopped:false,
totalElapsed:0,
report:""
});

alarmSound.volume=1.0;
alarmSound.play();

if(navigator.vibrate){
navigator.vibrate([300,150,300,150,500]);
}

showDashboard();
}

// STATUS
window.setStatus=async function(id,status){
await updateDoc(doc(db,"incidents",id),{status});
}

window.stopTimer=async function(id,status){
const snap=doc(db,"incidents",id);
await updateDoc(snap,{
status,
timerStopped:true,
totalElapsed:Date.now()
});
}

// REPORT PAGE
window.openReport=function(id){
const text=prompt("Write report:");
if(text){
updateDoc(doc(db,"incidents",id),{report:text});
}
}

// CLEAR COMPLETED
window.clearCompleted=async function(){
const snapshot=await onSnapshot(q,()=>{});
}

// FORMAT TIME
function formatTime(ms){
let seconds=Math.floor(ms/1000);
let h=Math.floor(seconds/3600);
let m=Math.floor((seconds%3600)/60);
let s=seconds%60;
return `${h}h ${m}m ${s}s`;
}

let previousStatuses={};

// REALTIME
onSnapshot(q,(snapshot)=>{
let activeHTML="";
let completedHTML="";

snapshot.forEach(docSnap=>{
const i=docSnap.data();
const id=docSnap.id;

let elapsed=i.timerStopped?i.totalElapsed:(Date.now()-i.startTime);

// SOUND TRIGGERS
if(previousStatuses[id] && previousStatuses[id]!==i.status){

if(i.status==="StandingOff"){
standOffChime.volume=1.0;
standOffChime.play();
}

if(i.status==="Completed"){
completedSound.volume=1.0;
completedSound.play();
}
}
previousStatuses[id]=i.status;

let card=`
<div class="card">
<b>${i.address}</b><br>
<span class="description">${i.description}</span><br>
Priority: ${i.priority}<br>
COS: ${i.cos}<br>
<span class="status-label">Status: ${i.status}</span><br>
Time: ${formatTime(elapsed)}<br>
<a class="map-link" target="_blank"
href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.address)}">
Open Map</a><br>
`;

if(i.status!=="Completed"){
card+=`
<button class="Responding" onclick="setStatus('${id}','Responding')">Responding</button>
<button class="Busy" onclick="setStatus('${id}','Busy')">Busy</button>
<button class="StandingOff" onclick="stopTimer('${id}','StandingOff')">Standing Off</button>
<button class="Completed" onclick="stopTimer('${id}','Completed')">Completed</button>
<button onclick="openReport('${id}')">Write Report</button>
</div>`;
activeHTML+=card;
}else{
card+=i.report?`<hr><b>Report:</b><br>${i.report}`:"";
card+="</div>";
completedHTML+=card;
}
});

activeList.innerHTML=activeHTML;
completedList.innerHTML=completedHTML;
});

// CLOCK
setInterval(()=>{
dateTime.innerText=new Date().toLocaleString();
},1000);

</script>
</body>
</html>
